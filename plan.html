<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boozt Play Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Calistoga&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: 'Calistoga', cursive; margin: 0; }
    .navbar {
      height: 90px;
      background: linear-gradient(90deg, #db0073, #ff7200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 40px;
    }
    .logo { height: 80px; }
    .top-icons ul {
      display: flex; gap: 30px; list-style: none;
    }
    .top-icons ul li a {
      color: white; font-weight: bold; text-decoration: none;
    }
    #map { height: 85vh; width: 100%; }
    .controls {
      display: flex; justify-content: center; gap: 10px; padding: 10px; background: #f9f9f9;
      flex-wrap: wrap;
    }
    .controls input, .controls button {
      padding: 5px 10px; font-size: 14px;
    }
  </style>
</head>
<body>

<div class="navbar">
  <img src="logo.png" alt="Boozt Play Logo" class="logo" />
  <div class="top-icons">
    <ul>
      <li><a href="index.html">Hem</a></li>
      <li><a href="aboutus.html">Om oss</a></li>
      <li><a href="plan.html">Hitta Plan</a></li>
      <li><a href="club.html">Lägg till din idrottsförening på kartan</a></li>
      <li><a href="Kontakta.html">Kontakt</a></li>
    </ul>
  </div>
</div>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Sök sport (t.ex. Cricket)" />
  <button onclick="searchMarker()">Sök</button>
  <input type="text" id="locationInput" placeholder="Sök plats (t.ex. Malmö)" />
  <button onclick="searchLocation()">Sök plats</button>
  <button onclick="enableAddPin()">Lägg till klubb</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCZnYVLnv2GgUvZwhwCisMau6x2feqtrUI",
    authDomain: "booztplay-fecf3.firebaseapp.com",
    projectId: "booztplay-fecf3",
    storageBucket: "booztplay-fecf3.firebasestorage.app",
    messagingSenderId: "582387623597",
    appId: "1:582387623597:web:51ad0b09ee1bc0f57d8824",
    measurementId: "G-WZMGYSS1YD"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  firebase.analytics();

  const map = L.map('map').setView([57.7089, 11.9746], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const icons = {
    Football: L.icon({ iconUrl: 'https://img.icons8.com/ios-glyphs/30/football2--v1.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] }),
    Cricket: L.icon({ iconUrl: 'https://img.icons8.com/external-icongeek26-outline-icongeek26/64/external-Cricket-stadiums-and-games-icongeek26-outline-icongeek26.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] }),
    Curling: L.icon({ iconUrl: 'https://img.icons8.com/ios-glyphs/30/curling-.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] }),
    Rugby: L.icon({ iconUrl: 'https://img.icons8.com/ios-glyphs/30/rugby.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] }),
    "American Football": L.icon({ iconUrl: 'https://img.icons8.com/ios-glyphs/30/american-football.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] }),
    Default: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] })
  };

  const markers = [];

  function addMarker(club) {
    const icon = icons[club.sport] || icons.Default;
    const marker = L.marker([club.lat, club.lng], { icon }).addTo(map)
      .bindPopup(`<b>${club.name}</b><br>Sport: ${club.sport}<br>📞 ${club.phone}<br>✉️ ${club.email}`);
    markers.push({ ...club, marker });
  }

  async function loadClubsFromFirestore() {
    const snapshot = await db.collection("clubs").get();
    snapshot.forEach(doc => addMarker(doc.data()));
  }
  loadClubsFromFirestore();

  window.searchMarker = function () {
    const query = document.getElementById('searchInput').value.toLowerCase();
    markers.forEach(obj => {
      if (obj.name.toLowerCase().includes(query) || obj.sport.toLowerCase().includes(query)) {
        map.setView(obj.marker.getLatLng(), 14);
        obj.marker.openPopup();
      }
    });
  };

  window.searchLocation = function () {
    const location = document.getElementById('locationInput').value;
    if (!location) return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length > 0) {
          const { lat, lon } = data[0];
          map.setView([parseFloat(lat), parseFloat(lon)], 13);
        } else {
          alert("Platsen hittades inte.");
        }
      });
  };

  window.enableAddPin = async function () {
    const code = prompt("Ange tillgångskod:");
    if (code !== "BOOZT2024") return alert("Fel kod.");

    const name = prompt("Klubbnamn (ex: Malmö Tigers Cricket Club):");
    const sport = prompt("Sport (ex: Cricket, Football):");
    const phone = prompt("Telefonnummer (ex: 0701234567):");
    const email = prompt("Email (ex: info@malmotigers.se):");
    const address = prompt("Adress eller plats (ex: Malmö Stadion):");
    const latStr = prompt("Latitud (valfritt – ex: 55.604981):");
    const lngStr = prompt("Longitud (valfritt – ex: 13.003822):");

    if (!name || !sport || !phone || !email || !address) return alert("Alla fält krävs (utom lat/lng).");

    let lat, lng;

    if (latStr && lngStr) {
      lat = parseFloat(latStr);
      lng = parseFloat(lngStr);
      if (isNaN(lat) || isNaN(lng)) return alert("Latitud och longitud måste vara siffror.");
    } else {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
      const data = await res.json();
      if (data.length > 0) {
        lat = parseFloat(data[0].lat);
        lng = parseFloat(data[0].lon);
      } else {
        return alert("Kunde inte hitta platsen via adress. Ange lat/lng istället.");
      }
    }

    const newClub = { name, sport, phone, email, lat, lng };
    addMarker(newClub);
    map.setView([lat, lng], 14);
    await db.collection("clubs").add(newClub);
    alert("Klubben har lagts till!");
  };
</script>

</body>
</html>
